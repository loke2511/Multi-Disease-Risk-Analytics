{% extends "base.html" %}

{% block title %}Prediction History{% endblock %}

{% block extra_css %}
<style>
    .history-container {
        padding: 3rem 0;
        min-height: 100vh;
    }

    .history-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: var(--radius-xl);
        text-align: center;
        margin-bottom: 3rem;
        box-shadow: var(--shadow-lg);
    }

    .filters-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
    }

    .history-table {
        background: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: var(--bg-light);
    }

    th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 2px solid #e0e0e0;
    }

    td {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        color: var(--text-secondary);
    }

    tr:hover {
        background: var(--bg-light);
    }

    .risk-badge {
        padding: 0.5rem 1rem;
        border-radius: var(--radius-full);
        font-size: 0.875rem;
        font-weight: 600;
        color: white;
        display: inline-block;
    }

    .risk-badge.low {
        background: var(--success-color);
    }

    .risk-badge.medium {
        background: var(--warning-color);
    }

    .risk-badge.high {
        background: var(--danger-color);
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }

    .page-link {
        padding: 0.5rem 1rem;
        border: 2px solid var(--primary-color);
        border-radius: var(--radius-md);
        color: var(--primary-color);
        font-weight: 600;
        transition: all var(--transition-fast);
    }

    .page-link:hover {
        background: var(--primary-color);
        color: white;
    }

    .page-link.active {
        background: var(--primary-gradient);
        color: white;
        border-color: transparent;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-light);
    }

    .empty-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="history-container container">
    <!-- Header -->
    <div class="history-header fade-in">
        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem; color: white;">
            üìä Prediction History
        </h1>
        <p style="font-size: 1.125rem; margin: 0; opacity: 0.95;">
            Track and analyze all your disease risk predictions over time
        </p>
    </div>

    <!-- Filters -->
    <div class="filters-card slide-up">
        <form method="GET" action="{{ url_for('predictions.history') }}">
            <div class="filters-grid">
                <div class="form-group">
                    <label class="form-label">Filter by Disease</label>
                    <select name="disease" class="form-control" onchange="this.form.submit()">
                        <option value="">All Diseases</option>
                        {% for disease_key, disease_data in diseases.items() %}
                        <option value="{{ disease_key }}" {% if request.args.get('disease')==disease_key %}selected{%
                            endif %}>
                            {{ disease_data.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Filter by Risk Level</label>
                    <select name="risk" class="form-control" onchange="this.form.submit()">
                        <option value="">All Risk Levels</option>
                        <option value="Low" {% if request.args.get('risk')=='Low' %}selected{% endif %}>Low Risk
                        </option>
                        <option value="Medium" {% if request.args.get('risk')=='Medium' %}selected{% endif %}>Medium
                            Risk</option>
                        <option value="High" {% if request.args.get('risk')=='High' %}selected{% endif %}>High Risk
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <a href="{{ url_for('predictions.history') }}" class="btn btn-outline" style="width: 100%;">
                        Clear Filters
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- History Table -->
    <div class="history-table slide-up">
        {% if predictions.items %}
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Disease</th>
                    <th>Result</th>
                    <th>Risk Level</th>
                    <th>Confidence</th>
                    <th>Report ID</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for prediction in predictions.items %}
                <tr>
                    <td>
                        <strong>{{ prediction.created_at.strftime('%b %d, %Y') }}</strong><br>
                        <small style="color: var(--text-light);">
                            {{ prediction.created_at.strftime('%I:%M %p') }}
                        </small>
                    </td>
                    <td>
                        <strong style="color: var(--text-primary);">{{ prediction.disease_name }}</strong>
                    </td>
                    <td>
                        <span
                            style="color: {% if prediction.prediction_result == 'Positive' %}var(--danger-color){% else %}var(--success-color){% endif %}; font-weight: 600;">
                            {{ prediction.prediction_result }}
                        </span>
                    </td>
                    <td>
                        <span
                            class="risk-badge {{ prediction.risk_level.lower() if prediction.risk_level else 'low' }}">
                            {{ prediction.risk_level or 'Unknown' }}
                        </span>
                    </td>
                    <td>{{ "%.1f"|format(prediction.confidence_score) }}%</td>
                    <td>
                        <code style="font-size: 0.875rem;">{{ prediction.report_id }}</code>
                    </td>
                    <td>
                        <a href="{{ url_for('predictions.result', prediction_id=prediction.id) }}" class="btn btn-sm"
                            style="background: var(--primary-color); color: white; margin-right: 0.5rem;">
                            View
                        </a>
                        <a href="{{ url_for('reports.generate_report', prediction_id=prediction.id) }}"
                            class="btn btn-outline btn-sm">
                            PDF
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        {% if predictions.pages > 1 %}
        <div class="pagination">
            {% if predictions.has_prev %}
            <a href="{{ url_for('predictions.history', page=predictions.prev_num, disease=request.args.get('disease'), risk=request.args.get('risk')) }}"
                class="page-link">
                ‚Üê Previous
            </a>
            {% endif %}

            {% for page_num in predictions.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
            <a href="{{ url_for('predictions.history', page=page_num, disease=request.args.get('disease'), risk=request.args.get('risk')) }}"
                class="page-link {% if page_num == predictions.page %}active{% endif %}">
                {{ page_num }}
            </a>
            {% else %}
            <span class="page-link" style="border: none; cursor: default;">...</span>
            {% endif %}
            {% endfor %}

            {% if predictions.has_next %}
            <a href="{{ url_for('predictions.history', page=predictions.next_num, disease=request.args.get('disease'), risk=request.args.get('risk')) }}"
                class="page-link">
                Next ‚Üí
            </a>
            {% endif %}
        </div>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <h3 style="color: var(--text-secondary); margin-bottom: 1rem;">No Predictions Found</h3>
            <p style="margin-bottom: 2rem;">
                {% if request.args.get('disease') or request.args.get('risk') %}
                No predictions match your current filters. Try adjusting the filters or clearing them.
                {% else %}
                You haven't made any predictions yet. Start by selecting a disease from the dashboard.
                {% endif %}
            </p>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                Go to Dashboard
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}